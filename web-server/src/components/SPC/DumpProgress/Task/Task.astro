---
import clsx from "clsx";
import { createUniqueId } from "solid-js";
import { TaskStatusIndicator } from "./TaskStatusIndicator";
import TaskTime from "./TaskTime.astro";

export type TaskStatus = "DONE" | "FAILED" | "RUNNING" | "QUEUED";

export interface TaskType {
    name: string;
    status: TaskStatus;
    startedAt?: Date;
    finishedAt?: Date;
    message?: string;
    dumpDate?: string;
}

export interface TaskTypeWithDumpDate extends TaskType {
    dumpDate: string;
}

interface Props {
    tasks: TaskType[];
    className?: string;
}

const { tasks, className } = Astro.props;
const uuid = createUniqueId();
---

<div class="flex flex-col gap-2">
    {
        tasks.map((t, i) => (
            <div
                class={clsx(
                    "task dark-layer-1",
                    t.message != null && "grid-rows-3 lg:grid-rows-2",
                    className,
                )}>
                <div class="flex items-center gap-2">
                    <TaskStatusIndicator status={t.status} client:load />

                    <div class="leading-tight flex flex-col">
                        <span>{t.name}</span>
                        {t.status == "QUEUED" && (
                            <span class="text-secondary text-sm">
                                Dump date: {t.dumpDate}
                            </span>
                        )}
                    </div>
                </div>

                {t.startedAt != null && t.finishedAt != null && (
                    <TaskTime
                        startedAt={t.startedAt}
                        finishedAt={t.finishedAt}
                    />
                )}

                {t.message != null && (
                    <>
                        <span
                            class="text-sm text-red-500 dark:text-red-400 text-ellipsis line-clamp-2"
                            data-tooltip-target={uuid + "tooltip-msg" + i}
                            aria-describedby={uuid + "tooltip-msg" + i}>
                            {t.message}
                        </span>
                        <div
                            id={uuid + "tooltip-msg" + i}
                            role="tooltip"
                            class="default-tooltip tooltip">
                            {t.message}
                            <div class="tooltip-arrow" data-popper-arrow />
                        </div>
                    </>
                )}
            </div>
        ))
    }
</div>

<style>
    .task {
        @apply grid grid-cols-2  grid-rows-2 lg:grid-rows-1 items-center gap-2 border rounded px-2 py-1 justify-between;
    }
</style>
